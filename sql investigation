WITH A AS(

select distinct
  CASE  
  WHEN COUNT(CASE WHEN IsMaster = 1 AND ECM.SystemTableID = 240 THEN 1 END) OVER (PARTITION BY ECM.ENTITYID) > 0  
	THEN MAX(CASE WHEN IsMaster = 1 AND ECM.SystemTableID = 240 THEN ISNULL(TPA.PTY_ID, 0) END) OVER (PARTITION BY ECM.ENTITYID)      
  WHEN COUNT(CASE WHEN IsMaster = 1 AND ECM.SystemTableID = 248 AND OCI_CMD.PTY_ID IS NOT NULL THEN 1 END) OVER (PARTITION BY ECM.ENTITYID) > 0 
	THEN MAX(CASE WHEN IsMaster = 1 AND ECM.SystemTableID = 248 AND OCI_CMD.PTY_ID IS NOT NULL THEN ISNULL(OCI_CMD.PTY_ID, 0) END) OVER (PARTITION BY ECM.ENTITYID)
  ELSE MIN(ISNULL(TPA.PTY_ID, 0)) OVER (PARTITION BY ECM.ENTITYID)         
  END AS OCIS_ID,

 CASE
        WHEN COUNT(CASE WHEN IsMaster = 1 AND ECM.SystemTableID = 240 THEN 1 END) OVER (PARTITION BY ECM.ENTITYID) > 0
            THEN 1  --OCIS master
        WHEN COUNT(CASE WHEN IsMaster = 1 AND ECM.SystemTableID = 248 AND OCI_CMD.PTY_ID IS NOT NULL THEN 1 END) OVER (PARTITION BY ECM.ENTITYID) > 0
            THEN 2  --CMD master's ocis connection	
        ELSE 3 --lowest 
    END AS DERIVATION




,ecm.entityid
--,*
from tblEntityCustomerMappings ecm

--TO GET CMD MASTERED
left join TQU_CUST_SYSALIAS_CUR_CMD SYSA
ON SYSA.CustomerMappingKey = ECM.CustomerMappingKey
AND SYSA.SYSTEM_NAME = 'CODOS'
AND SYSA.DATE_ENDED = '9999-01-01'
AND ECM.SystemTableID = 248
AND ECM.IsMaster = 1
--ONLY ACTIVE CMD
LEFT JOIN TPA_PARTY_OCI OCI_CMD
ON TRY_CAST(SYSA.SYSTEM_ALIAS AS INT) = OCI_CMD.PTY_ID
AND OCI_CMD.DATE_ENDED = '9999-01-01'


--ONLY ACTIVE OCIS ID'S 
LEFT JOIN TPA_PARTY_OCI TPA
ON TPA.CUSTOMERMAPPINGKEY = ECM.CustomerMappingKey
AND ECM.SystemTableID = 240
AND TPA.DATE_ENDED = '9999-01-01'




where ECM.entityid is not null
and ecm.SystemTableID in (240,248)
AND ( OCI_CMD.PTY_ID IS NOT NULL OR TPA.PTY_ID IS NOT NULL )  --HAS CMD OCIS CONNECTION FROM CMD OR IN AN ENTITY WITH AN OCIS ID

--AND ECM.EntityID = 2001399351

)

select entityid, OCIS_ID, DERIVATION into #OCIS_INF FROM 
A
